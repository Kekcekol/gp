<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Призраки Везенбергского квартала</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
  
  <!-- Подключение CSS -->
  <style>
    /* play.css - интегрированные стили */
    :root {
      --bg-color: #000;
      --ui-bg: rgba(0, 0, 0, 0.75);
      --text-color: #ffffff;
      --highlight-color: #fff;
      --border-radius: 10px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      position: fixed;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overscroll-behavior: none;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      -webkit-text-size-adjust: none;
      text-size-adjust: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Контейнер игры - занимает весь экран */
    #game-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Контент игры с фиксированным соотношением сторон */
    #game-content {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      overflow: hidden;
      background: #000;
      transition: var(--transition);
    }

    #canvas, #overlayDiv {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0 none;
    }

    #canvas {
      background: var(--bg-color);
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
      will-change: transform;
      touch-action: none;
    }

    .visible {
      visibility: visible;
      opacity: 1;
      transition: opacity 0.1s linear;
    }

    .hidden {
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s 0.25s, opacity 0.25s linear;
    }

    #statusDiv, #inputDiv {
      background: var(--ui-bg);
      width: min(90%, 500px);
      margin: 0 auto;
      padding: 12px;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      backdrop-filter: blur(5px);
      z-index: 100;
    }

    #statusTextDiv {
      overflow: auto;
      max-height: 40vh;
      color: #ccc;
      font-size: 14px;
    }

    #statusProgress {
      display: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #333;
      margin-top: 10px;
    }

    #statusProgress::-webkit-progress-bar {
      background: #333;
      border-radius: 4px;
    }

    #statusProgress::-webkit-progress-value {
      background: #4a90e2;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    #inputDiv {
      width: min(90%, 600px);
      padding: 15px;
    }

    #inputPrompt {
      color: var(--text-color);
      font-size: 1.4rem;
      margin-bottom: 1em;
    }

    #inputText {
      width: 100%;
      font-size: 1.2rem;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
      border: 1px solid #555;
      border-radius: var(--border-radius);
      outline: none;
      transition: var(--transition);
    }

    #inputText:focus {
      color: var(--highlight-color);
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
    }

    /* Контейнер для меню (левый верхний угол) */
    #ContextContainer {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      z-index: 1000;
    }

    /* Контейнер для кнопки полноэкранного режима (правый верхний угол) */
    #TopRightContainer {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .icon-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      color: lightgrey;
      background: rgba(0, 0, 0, 0.5);
      border-radius: var(--border-radius);
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      border: none;
      padding: 0;
      font-size: 24px;
    }

    .icon-button:hover, .icon-button:focus {
      color: var(--highlight-color);
      background: rgba(0, 0, 0, 0.7);
      outline: none;
    }

    .icon-button:active {
      transform: scale(0.9);
    }

    .icon-button img {
      width: 24px;
      height: 24px;
      pointer-events: none;
    }

    #ContextMenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius);
      padding: 8px;
      z-index: 1001;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
      min-width: 200px;
    }

    #ContextMenu.visible {
      display: block;
      animation: fadeIn 0.25s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: var(--text-color);
      background: rgba(50, 50, 50, 0.7);
      border-radius: var(--border-radius);
      margin: 6px 0;
      text-decoration: none;
      transition: var(--transition);
      font-size: 1.1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      width: 100%;
      text-align: left;
    }

    .context-menu-item:hover {
      background: rgba(70, 70, 70, 0.9);
      color: var(--highlight-color);
      transform: translateX(5px);
      border-color: rgba(255, 255, 255, 0.3);
    }

    #presplash {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
      animation: fadeIn 1s ease-out;
    }

    /* Индикатор загрузки */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      z-index: 10000;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Модальное окно для установки */
    #installModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
    }

    #installModal.visible {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background: var(--ui-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      max-width: 90%;
      width: 400px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .modal-title {
      font-size: 1.5rem;
      margin-bottom: 15px;
      color: var(--highlight-color);
    }

    .modal-text {
      margin-bottom: 20px;
      line-height: 1.5;
      color: var(--text-color);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .modal-button {
      padding: 10px 20px;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: var(--transition);
    }

    .modal-button.primary {
      background: #4a90e2;
      color: white;
    }

    .modal-button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .modal-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Сообщение о беззвучном режиме */
    .silent-warning {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      text-align: center;
      backdrop-filter: blur(5px);
    }

    .silent-warning-content p {
      margin: 0;
      font-size: 14px;
    }

    /* Адаптивные стили */
    @media (max-width: 768px) {
      #ContextContainer, #TopRightContainer {
        top: 15px;
      }
      
      #ContextContainer {
        left: 15px;
      }
      
      #TopRightContainer {
        right: 15px;
      }
      
      #statusDiv, #inputDiv {
        width: 95%;
        padding: 10px;
      }
      
      #inputPrompt {
        font-size: 1.2rem;
      }
      
      #inputText {
        font-size: 1rem;
        padding: 8px 12px;
      }
      
      .context-menu-item {
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .icon-button {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      
      .icon-button img {
        width: 20px;
        height: 20px;
      }

      .modal-content {
        padding: 20px;
        width: 95%;
      }

      .modal-title {
        font-size: 1.3rem;
      }
      
      /* Адаптация безопасных зон для iOS */
      @supports (padding: max(0px)) {
        #ContextContainer {
          top: max(15px, env(safe-area-inset-top));
          left: max(15px, env(safe-area-inset-left));
        }
        
        #TopRightContainer {
          top: max(15px, env(safe-area-inset-top));
          right: max(15px, env(safe-area-inset-right));
        }
        
        .silent-warning {
          top: max(70px, calc(env(safe-area-inset-top) + 50px));
        }
      }
    }

    /* Специальные стили для standalone режима на iOS */
    .standalone-mode #game-container {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .standalone-mode.landscape #game-content {
      width: auto !important;
      height: 100% !important;
      padding-bottom: 0 !important;
    }
  </style>
  
  <!-- Оптимизация загрузки иконок -->
  <link rel="icon" href="icons/icon-192x192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Призраки Везенберга">

  <!-- Предзагрузка критических ресурсов -->
  <link rel="preload" href="renpy-pre.js" as="script">
  <link rel="preload" href="renpy.js" as="script">
  <link rel="preload" href="web-presplash.jpg" as="image">
</head>

<body>
  <div class="loader"></div>
  
  <div id="game-container">
    <div id="game-content">
      <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
      <div id="overlayDiv"></div>

      <img id="presplash" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1' height='1' viewBox='0 0 1 1'%3E%3C/svg%3E" 
           data-src="web-presplash.jpg" alt="Загрузка игры...">
    </div>
  </div>

  <!-- Левый верхний угол - меню -->
  <div id="ContextContainer">
    <button id="ContextButton" class="icon-button" aria-label="Меню">≡</button>
    <div id="ContextMenu">
      <input id="ID_SavegamesImport" type="file" onchange="onSavegamesImport(this)" accept="application/zip" hidden>
      <a href="index.html" class="context-menu-item">Назад к играм</a>
      <button id="installMenuItem" class="context-menu-item">Инструкция для iPhone</button>
    </div>
  </div>

  <!-- Правый верхний угол - полноэкранный режим -->
  <div id="TopRightContainer">
    <button id="FullscreenButton" class="icon-button" aria-label="Полноэкранный режим">
      <img id="FullscreenIcon" src="icons/fullscreen.png" alt="Полноэкранный режим">
    </button>
  </div>

  <!-- Модальное окно для установки -->
  <div id="installModal">
    <div class="modal-content">
      <h2 class="modal-title">Инструкция для iPhone</h2>
      <p class="modal-text">Для установка приложения на главный экран:</p>
      
      <ol class="modal-text">
        <li>Нажмите кнопку "Поделиться" внизу браузера</li>
        <li>Прокрутите меню вниз и выберите "На экран «Домой»"</li>
        <li>Нажмите "Добавить" в правом верхнем углу</li>
        <li>Далее зайдите в приложение и начните играть в полноэкранном режима</li>
      </ol>
      
      <div class="modal-buttons">
        <button class="modal-button secondary" id="closeInstallModal">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Сообщение о беззвучном режиме для iOS -->
  <div id="silentModeWarning" class="silent-warning hidden">
    <div class="silent-warning-content">
      <p>С бесшумным режимом вы не услышите музыки</p>
    </div>
  </div>

  <div id="statusDiv" class="hidden">
    <div id="statusTextDiv"></div>
    <progress id="statusProgress" value="0" max="100"></progress>
  </div>

  <div id="inputDiv" class="hidden">
    <form id="inputForm">
      <div id="inputPrompt"></div>
      <input id="inputText" type="text" autocomplete="off">
    </form>
  </div>

  <script>
    // Глобальные переменные для функций меню
    let closeContextMenu, openContextMenu;
    
    // Глобальные переменные для управления аудио
    let audioContext = null;
    let isAudioPausedByApp = false;
    
    // Глобальные переменные для предотвращения масштабирования
    let gameStarted = false;
    let lastTouchEnd = 0;
    
    // Глобальные переменные для отслеживания ориентации и размера
    let lastOrientation = window.orientation;
    let lastWidth = window.innerWidth;
    let lastHeight = window.innerHeight;
    let resizeCheckInterval;
    let isStandalone = false;
    
    // Основной код JavaScript
    window.gameZipURL = 'game.zip';
    
    // Функции для предотвращения масштабирования
    function preventZoom(event) {
      if (gameStarted) return;
      
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }

    function preventDoubleTapZoom(event) {
      if (gameStarted) return;
      
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }

    function preventGesture(event) {
      if (!gameStarted) event.preventDefault();
    }
    
    // Функция для определения standalone режима
    function checkStandaloneMode() {
      isStandalone = (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches);
      return isStandalone;
    }
    
    // Функция для получения реальных размеров экрана
    function getScreenDimensions() {
      return {
        width: window.innerWidth,
        height: window.innerHeight,
        availWidth: window.screen.availWidth,
        availHeight: window.screen.availHeight
      };
    }
    
    // Функция для обработки изменения ориентации и размера
    function handleOrientationChange() {
      const container = document.getElementById('game-container');
      const content = document.getElementById('game-content');
      const canvas = document.getElementById('canvas');
      
      if (!container || !content) return;
      
      // Получаем реальные размеры
      const dims = getScreenDimensions();
      const isPortrait = dims.height > dims.width;
      
      // Сбрасываем трансформации
      content.style.transform = '';
      content.style.width = '';
      content.style.height = '';
      content.style.paddingBottom = '';
      
      if (isPortrait) {
        // Вертикальная ориентация - растягиваем по ширине
        content.style.width = '100%';
        content.style.paddingBottom = '56.25%'; // 16:9
      } else {
        // Горизонтальная ориентация - растягиваем по высоте
        const scale = dims.height / (dims.width * 0.5625); // 9/16 = 0.5625
        content.style.width = (scale * 100) + '%';
        content.style.paddingBottom = (scale * 56.25) + '%';
        content.style.margin = '0 auto';
      }
      
      // Для standalone режима убираем возможные отступы
      if (checkStandaloneMode()) {
        container.style.paddingTop = '0';
        container.style.paddingBottom = '0';
        
        // Дополнительная корректировка для горизонтальной ориентации
        if (!isPortrait) {
          const scaleCorrection = dims.height / dims.availHeight;
          if (scaleCorrection < 0.95) {
            content.style.transform = `scale(${scaleCorrection})`;
          }
        }
      }
      
      // Принудительно обновляем размеры канваса
      if (canvas) {
        canvas.style.width = '100%';
        canvas.style.height = '100%';
      }
      
      // Вызываем событие resize для обновления рендера игры
      setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
      }, 100);
    }
    
    // Функция для постоянной проверки размера
    function startResizeChecking() {
      // Останавливаем предыдущий интервал, если он был
      if (resizeCheckInterval) clearInterval(resizeCheckInterval);
      
      // Запускаем проверку каждые 50ms для быстрой реакции
      resizeCheckInterval = setInterval(() => {
        const dims = getScreenDimensions();
        const sizeChanged = dims.width !== lastWidth || dims.height !== lastHeight;
        const orientationChanged = window.orientation !== lastOrientation;
        
        if (sizeChanged || orientationChanged) {
          lastWidth = dims.width;
          lastHeight = dims.height;
          lastOrientation = window.orientation;
          handleOrientationChange();
        }
      }, 50);
    }
    
    // Функция для принудительной проверки безопасных зон
    function checkSafeAreas() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (!isIOS) return;
      
      const container = document.getElementById('game-container');
      if (!container) return;
      
      // Проверяем, есть ли отступы в standalone режиме
      if (checkStandaloneMode()) {
        const dims = getScreenDimensions();
        const isPortrait = dims.height > dims.width;
        
        // Добавляем отступы для безопасных зон
        container.style.paddingTop = 'env(safe-area-inset-top)';
        container.style.paddingBottom = 'env(safe-area-inset-bottom)';
        container.style.paddingLeft = 'env(safe-area-inset-left)';
        container.style.paddingRight = 'env(safe-area-inset-right)';
        
        // Для горизонтальной ориентации дополнительная корректировка
        if (!isPortrait) {
          handleOrientationChange();
        }
      }
    }
    
    // Перехватываем функцию presplashEnd из renpy-pre.js
    const originalPresplashEnd = window.presplashEnd;
    window.presplashEnd = function() {
      if (originalPresplashEnd) originalPresplashEnd();
      
      // Игра загружена, можно снять ограничения на масштабирование
      gameStarted = true;
      
      // Останавливаем проверку изменений размера
      if (resizeCheckInterval) clearInterval(resizeCheckInterval);
      
      // Убираем обработчики предотвращения масштабирования
      document.removeEventListener('touchstart', preventZoom);
      document.removeEventListener('touchmove', preventZoom);
      document.removeEventListener('touchend', preventDoubleTapZoom);
      document.removeEventListener('gesturestart', preventGesture);
      window.removeEventListener('orientationchange', handleOrientationChange);
    };
    
    // Регистрация Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        if (!navigator.serviceWorker.controller) {
          navigator.serviceWorker.register('./service-worker.js', { 
            updateViaCache: 'all',
            scope: './'
          });
        }
      });
    }
    
    // Функция проверки, запущено ли приложение с домашнего экрана
    function isRunningInStandaloneMode() {
      return window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    }
    
    // Функция проверки iOS устройства
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    // Показ сообщения о беззвучном режиме на iOS
    function showSilentModeWarning() {
      const warning = document.getElementById('silentModeWarning');
      if (!warning) return;
      
      // Проверяем, не показывали ли уже сообщение в этой сессии
      if (sessionStorage.getItem('silentWarningShown')) return;
      
      warning.classList.remove('hidden');
      
      // Скрываем сообщение через 5 секунд
      const hideTimeout = setTimeout(() => {
        hideSilentModeWarning();
      }, 5000);
      
      // Скрываем при клике в любом месте
      warning.addEventListener('click', function hideOnClick() {
        clearTimeout(hideTimeout);
        hideSilentModeWarning();
        warning.removeEventListener('click', hideOnClick);
      });
      
      // Также скрываем, если пользователь открыл инструкцию
      const installMenuItem = document.getElementById('installMenuItem');
      const installModal = document.getElementById('installModal');
      if (installMenuItem && installModal) {
        installMenuItem.addEventListener('click', function hideOnInstruction() {
          clearTimeout(hideTimeout);
          hideSilentModeWarning();
          installMenuItem.removeEventListener('click', hideOnInstruction);
        });
        
        installModal.addEventListener('click', function(e) {
          if (e.target === installModal || e.target.id === 'closeInstallModal') {
            clearTimeout(hideTimeout);
            hideSilentModeWarning();
          }
        });
      }
      
      sessionStorage.setItem('silentWarningShown', 'true');
    }
    
    function hideSilentModeWarning() {
      const warning = document.getElementById('silentModeWarning');
      if (warning) {
        warning.classList.add('hidden');
      }
    }
    
    // Функции для управления аудио
    function setupAudioManagement() {
      // Получаем аудиоконтекст игры, если доступен
      function getGameAudioContext() {
        if (typeof Module !== 'undefined' && Module.SDL2 && Module.SDL2.audioContext) {
          return Module.SDL2.audioContext;
        }
        return null;
      }
      
      // Приостановка аудио
      function pauseAudio() {
        audioContext = getGameAudioContext();
        if (audioContext && audioContext.state === 'running') {
          audioContext.suspend().then(() => {
            console.log('Аудио приостановлено');
            isAudioPausedByApp = true;
          }).catch(error => {
            console.error('Ошибка при приостановке аудио:', error);
          });
        }
        
        // Также приостанавливаем все HTML5 audio элементы
        document.querySelectorAll('audio, video').forEach(media => {
          if (!media.paused) {
            media.pause();
          }
        });
      }
      
      // Возобновление аудио
      function resumeAudio() {
        if (audioContext && audioContext.state === 'suspended' && isAudioPausedByApp) {
          audioContext.resume().then(() => {
            console.log('Аудио возобновлено');
            isAudioPausedByApp = false;
          }).catch(error => {
            console.error('Ошибка при возобновлении аудио:', error);
          });
        }
      }
      
      // Полная остановка аудио
      function stopAudio() {
        if (audioContext && audioContext.state !== 'closed') {
          audioContext.close().then(() => {
            console.log('Аудиоконтекст полностью закрыт');
          }).catch(error => {
            console.error('Ошибка при закрытии аудиоконтекста:', error);
          });
        }
        
        // Останавливаем все HTML5 audio элементы
        document.querySelectorAll('audio, video').forEach(media => {
          media.pause();
          media.currentTime = 0;
        });
      }
      
      // Обработчики событий видимости страницы
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // Страница скрыта (свернута или переключена вкладка)
          pauseAudio();
        } else {
          // Страница снова видна
          resumeAudio();
        }
      });
      
      // Обработчик события beforeunload (закрытие страницы)
      window.addEventListener('beforeunload', () => {
        stopAudio();
      });
      
      // Обработчик события pagehide (для мобильных устройств)
      window.addEventListener('pagehide', () => {
        stopAudio();
      });
      
      // Обработчик для iOS - при переходе в режим ожидания
      document.addEventListener('webkitvisibilitychange', () => {
        if (document.webkitHidden) {
          pauseAudio();
        } else {
          resumeAudio();
        }
      });
    }
    
    // Функция для предотвращения дублирования музыки
    function preventAudioDuplication() {
      // Проверяем, был ли уже инициализирован аудиоконтекст
      if (typeof Module !== 'undefined' && Module.SDL2) {
        // Если аудиоконтекст уже существует, закрываем его перед созданием нового
        if (Module.SDL2.audioContext && Module.SDL2.audioContext.state !== 'closed') {
          Module.SDL2.audioContext.close().catch(() => {});
        }
        
        // Перехватываем создание нового аудиоконтекста
        const originalConstructor = window.AudioContext || window.webkitAudioContext;
        
        if (originalConstructor) {
          window.AudioContext = function() {
            // Закрываем предыдущий контекст, если он есть
            if (Module.SDL2.audioContext && Module.SDL2.audioContext.state !== 'closed') {
              Module.SDL2.audioContext.close().catch(() => {});
            }
            
            const context = new originalConstructor();
            Module.SDL2.audioContext = context;
            return context;
          };
          
          window.AudioContext.prototype = originalConstructor.prototype;
          if (window.webkitAudioContext) {
            window.webkitAudioContext = window.AudioContext;
          }
        }
      }
    }
    
    // Основные функции приложения
    function loadResources() {
      // Загрузка прелоада с отложенным стартом
      const presplash = document.getElementById('presplash');
      if (presplash && presplash.dataset.src) {
        const img = new Image();
        img.src = presplash.dataset.src;
        img.onload = () => {
          presplash.src = img.src;
        };
      }
      
      // Динамическая загрузка скриптов
      const loadScript = (src) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.defer = true;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      };
      
      Promise.all([
        loadScript('renpy-pre.js'),
        loadScript('renpy.js')
      ]).catch(error => {
        console.error('Ошибка загрузки скриптов:', error);
      });
    }
    
    function hideLoader() {
      const loader = document.querySelector('.loader');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => {
          loader.style.display = 'none';
        }, 300);
      }
    }
    
    function setupContextMenu() {
      const contextButton = document.getElementById('ContextButton');
      const contextMenu = document.getElementById('ContextMenu');
      
      openContextMenu = () => {
        contextMenu.classList.add('visible');
        // Добавляем обработчик для закрытия при клике вне меню
        document.addEventListener('click', closeMenuOnClickOutside);
      };
      
      closeContextMenu = () => {
        contextMenu.classList.remove('visible');
        // Убираем обработчик при закрытии меню
        document.removeEventListener('click', closeMenuOnClickOutside);
      };
      
      // Функция для закрытия меню при клике вне его
      function closeMenuOnClickOutside(e) {
        // Проверяем, был ли клик вне меню и не по кнопке меню
        if (!contextMenu.contains(e.target) && e.target !== contextButton) {
          closeContextMenu();
        }
      }
      
      const toggleContextMenu = () => {
        if (contextMenu.classList.contains('visible')) {
          closeContextMenu();
        } else {
          openContextMenu();
        }
      };
      
      contextButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleContextMenu();
      });
      
      // Закрытие меню при выборе пунктов
      const contextItems = document.querySelectorAll('.context-menu-item');
      contextItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          closeContextMenu();
        });
      });
      
      // Обработка импорта сохранений
      const importButton = document.getElementById('ID_SavegamesImport');
      if (importButton) {
        importButton.addEventListener('change', function() {
          closeContextMenu();
          onSavegamesImport(this);
        });
      }
    }
    
    function setupFullscreen() {
      const fullscreenButton = document.getElementById('FullscreenButton');
      const fullscreenIcon = document.getElementById('FullscreenIcon');
      if (!fullscreenButton || !fullscreenIcon) return;
      
      // Проверяем, является ли устройство iOS
      const isIOSDevice = isIOS();
      
      // Скрываем кнопку полноэкранного режима на iOS
      if (isIOSDevice) {
        fullscreenButton.style.display = 'none';
        return;
      }
      
      // Функция переключения полноэкранного режима
      const toggleFullscreen = () => {
        if (!document.fullscreenElement && 
            !document.webkitFullscreenElement && 
            !document.mozFullScreenElement && 
            !document.msFullscreenElement) {
          const element = document.documentElement;
          if (element.requestFullscreen) {
            element.requestFullscreen();
          } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      };
      
      // Обновление иконки при изменении состояния
      const updateFullscreenIcon = () => {
        const isFullscreen = document.fullscreenElement || 
                           document.webkitFullscreenElement ||
                           document.mozFullScreenElement ||
                           document.msFullscreenElement;
        
        // Переключаем иконку (используем PNG)
        fullscreenIcon.src = isFullscreen ? 
          'icons/unfullscreen.png' : 
          'icons/fullscreen.png';
        
        // Обновляем подсказку
        fullscreenButton.setAttribute(
          'aria-label', 
          isFullscreen ? 'Выйти из полноэкранного режима' : 'Полноэкранный режим'
        );
      };
      
      // Обработчик клика по кнопке
      fullscreenButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFullscreen();
      });
      
      // Обновление иконки при изменении состояния
      document.addEventListener('fullscreenchange', updateFullscreenIcon);
      document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
      document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
      document.addEventListener('MSFullscreenChange', updateFullscreenIcon);
      
      // Инициализация иконки
      updateFullscreenIcon();
    }
    
    function setupInstallPrompt() {
      const installMenuItem = document.getElementById('installMenuItem');
      const installModal = document.getElementById('installModal');
      const closeInstallModal = document.getElementById('closeInstallModal');
      
      if (!installMenuItem || !installModal) return;
      
      // Проверяем, является ли устройство iOS
      const isIOSDevice = isIOS();
      
      // Проверяем, не установлено ли уже приложение
      const isStandalone = isRunningInStandaloneMode();
      
      // Показываем пункт меню установки только на iOS и если приложение еще не установлено
      if (isIOSDevice && !isStandalone) {
        installMenuItem.style.display = 'flex';
      } else {
        installMenuItem.style.display = 'none';
      }
      
      // Функция показа инструкций
      const showInstallInstructions = () => {
        installModal.classList.add('visible');
      };
      
      // Функция скрытия инструкций
      const hideInstallInstructions = () => {
        installModal.classList.remove('visible');
      };
      
      // Обработчик клика по пункту меню
      installMenuItem.addEventListener('click', (e) => {
        e.stopPropagation();
        closeContextMenu();
        showInstallInstructions();
      });
      
      closeInstallModal.addEventListener('click', hideInstallInstructions);
      
      // Закрытие модального окна при клике вне его
      installModal.addEventListener('click', (e) => {
        if (e.target === installModal) {
          hideInstallInstructions();
        }
      });
    }
    
    function setupIOSBehavior() {
      const isIOSDevice = isIOS();
      const isStandalone = isRunningInStandaloneMode();
      
      // Если это iOS и приложение запущено с домашнего экрана
      if (isIOSDevice && isStandalone) {
        // Скрываем все элементы интерфейса
        const contextContainer = document.getElementById('ContextContainer');
        const topRightContainer = document.getElementById('TopRightContainer');
        
        if (contextContainer) contextContainer.style.display = 'none';
        if (topRightContainer) topRightContainer.style.display = 'none';
        
        // Убедимся, что игра занимает весь экран
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.body.style.overflow = 'hidden';
      }
    }
    
    function setupIOSFix() {
      if (!isIOS()) return;
      
      const canvas = document.getElementById('canvas');
      if (!canvas) return;
      
      // Фикс для полноэкранного режима на iOS
      document.documentElement.style.height = '100%';
      document.body.style.height = '100%';
      document.body.style.overflow = 'hidden';
      
      // Фикс для touch-событий
      let lastTouchTime = 0;
      canvas.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchTime < 300) return;
        lastTouchTime = now;
        
        const clickEvent = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        e.target.dispatchEvent(clickEvent);
      }, { passive: true });
    }
    
    // Автоматическое открытие меню на iOS при загрузке
    function autoOpenMenuOnIOS() {
      const isIOSDevice = isIOS();
      const isStandalone = isRunningInStandaloneMode();
      
      // Открываем меню автоматически на iOS, если не в standalone режиме
      if (isIOSDevice && !isStandalone && typeof openContextMenu === 'function') {
        setTimeout(() => {
          openContextMenu();
        }, 1000);
      }
    }
    
    // Настройка предотвращения масштабирования
    function setupZoomPrevention() {
      // Добавляем обработчики для предотвращения масштабирования
      document.addEventListener('touchstart', preventZoom, { passive: false });
      document.addEventListener('touchmove', preventZoom, { passive: false });
      document.addEventListener('touchend', preventDoubleTapZoom, { passive: false });
      document.addEventListener('gesturestart', preventGesture, { passive: false });
      
      // Обработчик изменения ориентации
      window.addEventListener('orientationchange', handleOrientationChange);
      
      // Отмечаем начало игры при клике на канвас
      const canvas = document.getElementById('canvas');
      if (canvas) {
        canvas.addEventListener('click', function() {
          gameStarted = true;
        });
      }
      
      // Через 5 секунд считаем, что игра началась (fallback)
      setTimeout(() => {
        gameStarted = true;
      }, 5000);
    }
    
    // Инициализация приложения
    function init() {
      loadResources();
      setupContextMenu();
      setupFullscreen();
      setupInstallPrompt();
      setupIOSFix();
      setupIOSBehavior();
      autoOpenMenuOnIOS(); // Автоматическое открытие меню на iOS
      
      // Настройка предотвращения масштабирования
      setupZoomPrevention();
      
      // Проверяем standalone режим
      checkStandaloneMode();
      
      // Проверяем безопасные зоны
      checkSafeAreas();
      
      // Запускаем проверку изменений размера
      startResizeChecking();
      
      // Вызываем первоначальную настройку
      handleOrientationChange();
      
      // Настройка управления аудио
      setupAudioManagement();
      preventAudioDuplication();
      
      // Показываем предупреждение о беззвучном режиме на iOS
      if (isIOS()) {
        showSilentModeWarning();
      }
      
      // Обработчики событий
      window.addEventListener('load', hideLoader);
      window.addEventListener('error', hideLoader);
      
      // Дополнительные обработчики для standalone режима
      if (isStandalone) {
        window.addEventListener('resize', handleOrientationChange);
      }
    }
    
    // Запуск приложения после загрузки DOM
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>